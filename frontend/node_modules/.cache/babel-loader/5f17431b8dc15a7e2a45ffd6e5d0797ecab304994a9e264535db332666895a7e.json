{"ast":null,"code":"import Dexie from 'dexie';\n\n// Offline database for caching / قاعدة بيانات غير متصلة للتخزين المؤقت\nclass OfflineDatabase extends Dexie {\n  constructor() {\n    super('AidTraceDB');\n    this.version(1).stores({\n      projects: '++id, title, status, organisation, location, created_at',\n      users: '++id, username, email, role, organisation',\n      transactions: '++id, project_id, donor_id, amount, date, is_synced',\n      reports: '++id, project_id, submitted_by, type, title, is_synced',\n      distributions: '++id, project_id, field_officer_id, aid_type, is_synced',\n      organisations: '++id, name, type, registration_status',\n      syncQueue: '++id, type, data, timestamp, retries',\n      offlineActions: '++id, action_type, data, timestamp, is_synced'\n    });\n  }\n}\nconst db = new OfflineDatabase();\n\n// Offline service functions / وظائف الخدمة غير المتصلة\nexport const offlineService = {\n  // Cache data / تخزين البيانات مؤقتاً\n  async cacheProjects(projects) {\n    await db.projects.clear();\n    await db.projects.bulkAdd(projects);\n  },\n  async cacheUsers(users) {\n    await db.users.clear();\n    await db.users.bulkAdd(users);\n  },\n  async cacheOrganisations(organisations) {\n    await db.organisations.clear();\n    await db.organisations.bulkAdd(organisations);\n  },\n  // Get cached data / الحصول على البيانات المخزنة مؤقتاً\n  async getCachedProjects() {\n    return await db.projects.toArray();\n  },\n  async getCachedUsers() {\n    return await db.users.toArray();\n  },\n  async getCachedOrganisations() {\n    return await db.organisations.toArray();\n  },\n  // Store offline actions / تخزين الإجراءات غير المتصلة\n  async storeOfflineAction(actionType, data) {\n    const action = {\n      action_type: actionType,\n      data: JSON.stringify(data),\n      timestamp: new Date(),\n      is_synced: false\n    };\n    await db.offlineActions.add(action);\n    return action;\n  },\n  // Get pending sync actions / الحصول على الإجراءات المعلقة للمزامنة\n  async getPendingSyncActions() {\n    return await db.offlineActions.where('is_synced').equals(false).toArray();\n  },\n  // Mark action as synced / تحديد الإجراء كمتزامن\n  async markActionSynced(actionId) {\n    await db.offlineActions.update(actionId, {\n      is_synced: true\n    });\n  },\n  // Store form draft / تخزين مسودة النموذج\n  async storeDraft(formType, data) {\n    const draft = {\n      type: formType,\n      data: JSON.stringify(data),\n      timestamp: new Date(),\n      retries: 0\n    };\n    await db.syncQueue.add(draft);\n  },\n  // Get form drafts / الحصول على مسودات النماذج\n  async getDrafts(formType) {\n    return await db.syncQueue.where('type').equals(formType).toArray();\n  },\n  // Clear synced drafts / مسح المسودات المتزامنة\n  async clearSyncedDrafts() {\n    const syncedActions = await db.offlineActions.where('is_synced').equals(true).toArray();\n    const idsToDelete = syncedActions.map(action => action.id);\n    await db.offlineActions.bulkDelete(idsToDelete);\n  },\n  // Check if data exists offline / التحقق من وجود البيانات غير متصلة\n  async hasOfflineData() {\n    const projectsCount = await db.projects.count();\n    const usersCount = await db.users.count();\n    return projectsCount > 0 || usersCount > 0;\n  },\n  // Clear all offline data / مسح جميع البيانات غير المتصلة\n  async clearAllData() {\n    await db.projects.clear();\n    await db.users.clear();\n    await db.transactions.clear();\n    await db.reports.clear();\n    await db.distributions.clear();\n    await db.organisations.clear();\n    await db.syncQueue.clear();\n    await db.offlineActions.clear();\n  }\n};\n\n// Sync service for online/offline synchronization / خدمة المزامنة للمزامنة المتصلة/غير المتصلة\nexport const syncService = {\n  // Check online status / التحقق من حالة الاتصال\n  isOnline() {\n    return navigator.onLine;\n  },\n  // Sync pending actions when online / مزامنة الإجراءات المعلقة عند الاتصال\n  async syncPendingActions(apiService) {\n    if (!this.isOnline()) return;\n    const pendingActions = await offlineService.getPendingSyncActions();\n    for (const action of pendingActions) {\n      try {\n        const data = JSON.parse(action.data);\n        switch (action.action_type) {\n          case 'CREATE_PROJECT':\n            await apiService.createProject(data);\n            break;\n          case 'FUND_PROJECT':\n            await apiService.fundProject(data);\n            break;\n          case 'SUBMIT_REPORT':\n            await apiService.submitReport(data);\n            break;\n          case 'RECORD_DISTRIBUTION':\n            await apiService.recordDistribution(data);\n            break;\n          default:\n            console.warn('Unknown action type:', action.action_type);\n        }\n        await offlineService.markActionSynced(action.id);\n      } catch (error) {\n        console.error('Sync failed for action:', action.id, error);\n      }\n    }\n  },\n  // Setup sync listeners / إعداد مستمعي المزامنة\n  setupSyncListeners(apiService) {\n    // Listen for online/offline events\n    window.addEventListener('online', () => {\n      console.log('Back online, syncing data...');\n      this.syncPendingActions(apiService);\n    });\n    window.addEventListener('offline', () => {\n      console.log('Gone offline, storing actions locally...');\n    });\n\n    // Periodic sync when online\n    setInterval(() => {\n      if (this.isOnline()) {\n        this.syncPendingActions(apiService);\n      }\n    }, 30000); // Sync every 30 seconds\n  }\n};\nexport default db;","map":{"version":3,"names":["Dexie","OfflineDatabase","constructor","version","stores","projects","users","transactions","reports","distributions","organisations","syncQueue","offlineActions","db","offlineService","cacheProjects","clear","bulkAdd","cacheUsers","cacheOrganisations","getCachedProjects","toArray","getCachedUsers","getCachedOrganisations","storeOfflineAction","actionType","data","action","action_type","JSON","stringify","timestamp","Date","is_synced","add","getPendingSyncActions","where","equals","markActionSynced","actionId","update","storeDraft","formType","draft","type","retries","getDrafts","clearSyncedDrafts","syncedActions","idsToDelete","map","id","bulkDelete","hasOfflineData","projectsCount","count","usersCount","clearAllData","syncService","isOnline","navigator","onLine","syncPendingActions","apiService","pendingActions","parse","createProject","fundProject","submitReport","recordDistribution","console","warn","error","setupSyncListeners","window","addEventListener","log","setInterval"],"sources":["C:/Users/ajang/OneDrive/Desktop/Capstone_project_AidTrace_SS/frontend/src/services/offlineService.js"],"sourcesContent":["import Dexie from 'dexie';\n\n// Offline database for caching / قاعدة بيانات غير متصلة للتخزين المؤقت\nclass OfflineDatabase extends Dexie {\n  constructor() {\n    super('AidTraceDB');\n    \n    this.version(1).stores({\n      projects: '++id, title, status, organisation, location, created_at',\n      users: '++id, username, email, role, organisation',\n      transactions: '++id, project_id, donor_id, amount, date, is_synced',\n      reports: '++id, project_id, submitted_by, type, title, is_synced',\n      distributions: '++id, project_id, field_officer_id, aid_type, is_synced',\n      organisations: '++id, name, type, registration_status',\n      syncQueue: '++id, type, data, timestamp, retries',\n      offlineActions: '++id, action_type, data, timestamp, is_synced'\n    });\n  }\n}\n\nconst db = new OfflineDatabase();\n\n// Offline service functions / وظائف الخدمة غير المتصلة\nexport const offlineService = {\n  // Cache data / تخزين البيانات مؤقتاً\n  async cacheProjects(projects) {\n    await db.projects.clear();\n    await db.projects.bulkAdd(projects);\n  },\n\n  async cacheUsers(users) {\n    await db.users.clear();\n    await db.users.bulkAdd(users);\n  },\n\n  async cacheOrganisations(organisations) {\n    await db.organisations.clear();\n    await db.organisations.bulkAdd(organisations);\n  },\n\n  // Get cached data / الحصول على البيانات المخزنة مؤقتاً\n  async getCachedProjects() {\n    return await db.projects.toArray();\n  },\n\n  async getCachedUsers() {\n    return await db.users.toArray();\n  },\n\n  async getCachedOrganisations() {\n    return await db.organisations.toArray();\n  },\n\n  // Store offline actions / تخزين الإجراءات غير المتصلة\n  async storeOfflineAction(actionType, data) {\n    const action = {\n      action_type: actionType,\n      data: JSON.stringify(data),\n      timestamp: new Date(),\n      is_synced: false\n    };\n    \n    await db.offlineActions.add(action);\n    return action;\n  },\n\n  // Get pending sync actions / الحصول على الإجراءات المعلقة للمزامنة\n  async getPendingSyncActions() {\n    return await db.offlineActions.where('is_synced').equals(false).toArray();\n  },\n\n  // Mark action as synced / تحديد الإجراء كمتزامن\n  async markActionSynced(actionId) {\n    await db.offlineActions.update(actionId, { is_synced: true });\n  },\n\n  // Store form draft / تخزين مسودة النموذج\n  async storeDraft(formType, data) {\n    const draft = {\n      type: formType,\n      data: JSON.stringify(data),\n      timestamp: new Date(),\n      retries: 0\n    };\n    \n    await db.syncQueue.add(draft);\n  },\n\n  // Get form drafts / الحصول على مسودات النماذج\n  async getDrafts(formType) {\n    return await db.syncQueue.where('type').equals(formType).toArray();\n  },\n\n  // Clear synced drafts / مسح المسودات المتزامنة\n  async clearSyncedDrafts() {\n    const syncedActions = await db.offlineActions.where('is_synced').equals(true).toArray();\n    const idsToDelete = syncedActions.map(action => action.id);\n    await db.offlineActions.bulkDelete(idsToDelete);\n  },\n\n  // Check if data exists offline / التحقق من وجود البيانات غير متصلة\n  async hasOfflineData() {\n    const projectsCount = await db.projects.count();\n    const usersCount = await db.users.count();\n    return projectsCount > 0 || usersCount > 0;\n  },\n\n  // Clear all offline data / مسح جميع البيانات غير المتصلة\n  async clearAllData() {\n    await db.projects.clear();\n    await db.users.clear();\n    await db.transactions.clear();\n    await db.reports.clear();\n    await db.distributions.clear();\n    await db.organisations.clear();\n    await db.syncQueue.clear();\n    await db.offlineActions.clear();\n  }\n};\n\n// Sync service for online/offline synchronization / خدمة المزامنة للمزامنة المتصلة/غير المتصلة\nexport const syncService = {\n  // Check online status / التحقق من حالة الاتصال\n  isOnline() {\n    return navigator.onLine;\n  },\n\n  // Sync pending actions when online / مزامنة الإجراءات المعلقة عند الاتصال\n  async syncPendingActions(apiService) {\n    if (!this.isOnline()) return;\n\n    const pendingActions = await offlineService.getPendingSyncActions();\n    \n    for (const action of pendingActions) {\n      try {\n        const data = JSON.parse(action.data);\n        \n        switch (action.action_type) {\n          case 'CREATE_PROJECT':\n            await apiService.createProject(data);\n            break;\n          case 'FUND_PROJECT':\n            await apiService.fundProject(data);\n            break;\n          case 'SUBMIT_REPORT':\n            await apiService.submitReport(data);\n            break;\n          case 'RECORD_DISTRIBUTION':\n            await apiService.recordDistribution(data);\n            break;\n          default:\n            console.warn('Unknown action type:', action.action_type);\n        }\n        \n        await offlineService.markActionSynced(action.id);\n      } catch (error) {\n        console.error('Sync failed for action:', action.id, error);\n      }\n    }\n  },\n\n  // Setup sync listeners / إعداد مستمعي المزامنة\n  setupSyncListeners(apiService) {\n    // Listen for online/offline events\n    window.addEventListener('online', () => {\n      console.log('Back online, syncing data...');\n      this.syncPendingActions(apiService);\n    });\n\n    window.addEventListener('offline', () => {\n      console.log('Gone offline, storing actions locally...');\n    });\n\n    // Periodic sync when online\n    setInterval(() => {\n      if (this.isOnline()) {\n        this.syncPendingActions(apiService);\n      }\n    }, 30000); // Sync every 30 seconds\n  }\n};\n\nexport default db;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}